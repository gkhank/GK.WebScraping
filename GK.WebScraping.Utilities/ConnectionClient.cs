using GK.WebScraping.Model;
using Newtonsoft.Json;
using System;
using System.Diagnostics;
using System.IO;
using System.Net;

namespace GK.WebScraping.Utilities
{
    public class ConnectionClient
    {

        private WebProxy _proxy;

        private WebProxy Proxy
        {
            get
            {
                if (this._proxy == null)
                    this._proxy = SelectProxy();
                return this._proxy;
            }
        }


        private WebProxy SelectProxy()
        {
#warning TODO: Implement proxy selection according to this.GetAverage method with uptime response time and location data.

            String[] hosts = new string[] {
                "176.62.185.72:36493",
                "176.193.146.245:53281",
                "176.99.134.12:8080",
                "62.213.14.166:8080",
                "176.227.188.66:53281",
                "80.82.55.71:8080",
                "176.120.198.136:8080",
                "185.102.138.148:8080",
                "81.163.62.221:34011",
                "79.134.7.134:48900",
                "78.140.7.239:33943",
                "178.57.106.6:8080",
                "45.10.111.23:8080",
                "84.22.198.26:8080",
                "87.249.22.114:8080",
                "185.51.124.246:8080",
                "185.61.92.228:33060",
                "185.34.22.225:37879",
                "78.142.232.116:8080",
                "82.114.119.252:1256",
                "188.133.173.21:8080",
                "178.205.169.210:3128",
                "91.224.182.49:8080",
                "88.82.95.146:3128",
                "89.250.149.114:60981",
                "188.133.192.164:8081",
                "212.120.186.39:60963",
                "85.26.146.169:80",
                "80.249.135.241:8080",
                "88.205.225.203:3128",
                "92.255.248.230:45906",
                "94.140.208.226:8080",
                "188.168.75.254:56899",
                "89.208.35.81:3128",
                "46.29.11.254:57849",
                "89.20.102.147:2580",
                "82.114.106.40:1256",
                "46.52.148.90:8080",
                "90.189.116.152:3128",
                "91.216.66.70:32306",
                "195.239.178.110:48009",
                "92.255.196.91:8080",
                "158.255.51.213:61468",
                "194.135.15.6:56218",
                "95.79.55.196:53281",
                "194.67.111.150:3128",
                "89.208.35.79:60358",
                "94.247.241.70:53640",
                "46.229.67.198:47437",
                "89.237.33.126:37647",
                "95.165.4.178:8080",
                "193.228.135.139:8080",
                "94.253.15.25:37885",
                "195.170.38.230:8080",
                "31.204.180.44:53281",
                "91.77.162.117:8080",
                "195.46.124.94:4444",
                "93.157.251.134:3128",
                "5.16.0.97:1256",
                "93.171.192.28:8080",
                "109.195.251.81:8080",
                "94.180.106.94:32767",
                "109.167.134.253:30710",
                "94.232.11.178:46449",
                "94.28.30.252:8080",
                "109.70.189.70:56408",
                "84.42.4.170:8080",
                "31.7.232.178:8080",
                "31.192.107.144:3128",
                "84.22.195.194:8080",
                "46.146.244.97:44327",
                "91.203.36.102:45551",
                "91.217.42.4:8080",
                "62.152.75.110:50287",
                "94.140.242.221:8080",
                "195.182.141.2:3128",
                "80.65.28.57:30962",
                "176.120.211.250:8080",
                "178.74.110.238:8080",
                "194.135.75.74:55716",
                "188.133.173.20:8080",
                "192.162.192.148:55443",
                "213.167.59.142:8080",
                "83.242.251.36:8080",
                "79.142.84.242:3128",
                "193.232.252.38:8080",
                "37.29.80.161:8080",
                "91.122.232.230:8080",
                "109.70.189.79:53281",
                "37.110.6.178:8080",
                "173.212.202.65:80",
                "173.249.5.7:8080",
                "62.138.8.187:3128",
                "68.183.221.156:37486",
                "68.183.221.156:40156",
                "130.61.51.81:3128",
                "176.9.119.170:8080",
                "176.9.63.62:3128",
                "68.183.221.156:42255",
                "68.183.221.156:34961",
                "68.183.221.156:38145",
                "176.9.75.42:8080",
                "176.9.75.42:3128",
                "68.183.221.156:45770",
                "136.243.231.213:3128",
                "176.9.119.170:3128",
                "185.136.162.4:8080",
                "88.198.50.103:3128",
                "116.203.211.25:3128",
                "45.153.33.166:3128",
                "88.198.24.108:3128",
                "154.16.202.22:8080",
                "213.182.20.98:8080",
                "165.227.173.87:46669",
                "145.253.188.132:80",
                "88.198.24.108:8080",
                "46.4.96.137:8080",
                "88.198.50.103:8080",
                "157.230.103.189:34768",
                "188.166.162.1:3128",
                "154.16.202.22:3128",
                "157.230.103.189:35142",
                "157.230.103.189:34013",
                "167.71.41.173:44425",
                "167.99.131.11:80",
                "49.12.74.188:11624",
                "49.12.74.188:11345",
                "46.4.96.137:3128",
                "49.12.74.188:11626",
                "31.172.105.144:8080",
                "5.189.133.231:80",
                "167.71.41.173:33537",
                "165.227.173.87:45797",
                "193.36.33.3:8080",
                "5.189.185.139:3128",
                "157.230.103.189:45614",
                "157.230.103.189:42368",
                "68.183.221.156:33827",
                "144.76.42.215:8118",
                "68.183.221.156:34297",
                "78.47.16.54:80",
                "88.99.10.252:1080",
                "49.12.74.188:11700",
                "192.109.165.58:80",
                "192.109.165.41:80",
                "192.109.165.221:80",
                "167.71.41.173:34509",
                "192.109.165.55:80",
                "173.249.13.171:3128",
                "46.4.168.53:80",
                "157.230.103.189:39319",
                "192.109.165.194:80",
                "45.80.181.14:3128",
                "188.34.137.126:3128",
                "5.252.224.190:3128",
                "213.182.20.100:8080",
                "136.243.81.120:8080",
                "116.203.67.172:3128",
                "176.9.38.126:3128",
                "207.180.221.177:3128",
                "167.172.171.115:33045",
                "207.180.238.119:3128",
                "185.242.113.156:3128",
                "95.179.249.63:3128",
                "52.28.216.167:3128",
                "178.20.100.203:3128",
                "95.179.242.185:8080",
                "144.91.85.172:3128",
                "88.99.134.61:8080",
                "164.68.117.12:8889",
                "159.89.28.169:3128",
                "159.89.29.28:3128",
                "176.108.104.84:44704",
                "185.20.216.77:8088",
                "37.57.130.244:8282",
                "185.94.218.57:43403",
                "37.229.76.131:8080",
                "78.30.198.160:8080",
                "77.120.137.143:8080",
                "85.238.96.46:8080",
                "178.150.148.38:8282",
                "46.151.145.4:53281",
                "91.214.128.243:23500",
                "46.175.186.24:8081",
                "81.90.224.248:3128",
                "93.157.12.248:8080",
                "91.230.199.174:61440",
                "94.244.28.246:31280",
                "92.52.186.123:32329",
                "94.153.198.254:3128",
                "95.158.63.46:32923",
                "31.28.228.252:8080",
                "194.44.15.222:8081",
                "159.224.232.222:3128",
                "91.225.226.39:44388",
                "194.242.98.33:3128",
                "31.43.180.68:8080",
                "91.240.97.69:443",
                "193.200.151.69:48241",
                "193.41.88.58:53281",
                "109.254.47.147:3128",
                "91.209.11.131:80",
                "195.138.90.226:3128",
                "193.34.95.110:8080",
                "195.138.82.198:40301",
                "193.57.43.193:81",
                "109.110.73.106:32479",
                "109.237.91.155:8080",
                "80.73.9.238:808",
                "188.190.245.135:55443",
                "109.200.155.197:8080",
                "46.98.99.128:8080",
                "176.98.95.105:32018",
                "62.23.15.92:3128",
                "62.23.15.92:6666",
                "82.64.77.154:3128",
                "51.15.178.211:8118",
                "165.225.77.47:9400",
                "195.154.84.106:5566",
                "51.159.24.172:3155",
                "165.225.77.47:8800",
                "35.180.99.42:80",
                "165.225.77.47:443",
                "5.39.17.96:80",
                "195.154.173.28:80",
                "51.159.24.172:3166",
                "54.36.15.34:3128",
                "159.8.114.37:8123",
                "51.178.220.22:80",
                "51.158.123.35:9999",
                "51.178.220.22:443",
                "159.8.114.34:8123",
                "159.8.114.37:80",
                "51.178.220.22:3128",
                "52.143.130.19:3128",
                "185.156.173.101:8080",
                "194.250.57.253:8080",
                "81.255.13.197:8080",
                "92.245.142.215:8080",
                "90.83.154.85:8080",
                "51.159.24.172:3167",
                "163.172.52.122:3128",
                "176.235.99.12:9090",
                "185.124.87.67:3128",
                "176.235.99.103:9090",
                "176.236.160.152:8080",
                "78.186.98.244:9090",
                "78.111.97.182:3142",
                "78.111.97.180:3140",
                "85.105.139.53:8090",
                "88.255.102.38:9090",
                "91.93.73.229:7070",
                "212.156.55.34:8080",
                "95.0.219.201:8080",
                "95.0.219.249:8080",
                "95.9.150.33:55834",
                "213.14.32.73:9090",
                "95.0.219.204:8080",
                "176.236.85.246:9090",
                "176.235.80.102:9090",
                "213.14.3.154:3128",
                "185.200.38.74:8080",
                "217.195.203.28:3130",
                "176.236.99.215:8080",
                "176.103.33.189:8080",
                "176.103.33.188:8080",
                "78.11.85.15:8080",
                "178.212.54.137:8080",
                "88.220.104.178:8080",
                "46.170.26.42:8080",
                "91.150.189.122:30389",
                "91.192.2.168:53281",
                "213.216.67.190:8080",
                "83.168.86.170:8090",
                "91.225.11.51:8080",
                "193.34.55.64:32767",
                "178.217.216.184:49086",
                "178.217.140.70:443",
                "83.242.123.248:8080",
                "85.31.246.47:3128",
                "83.175.166.234:8080",
                "178.128.243.15:80",
                "40.68.220.250:3128",
                "185.204.187.79:2683",
                "185.204.187.168:2682",
                "45.84.58.165:8080",
                "163.172.221.209:443",
                "167.99.45.193:8080",
                "167.71.5.83:8080",
                "167.71.5.83:3128",
                "185.156.172.36:3128",
                "185.156.172.34:3128",
                "136.244.107.47:8088",
                "62.182.114.164:60731",
                "185.189.199.75:23500",
                "212.95.180.50:53281",
                "78.83.199.235:53281",
                "85.187.17.39:53281",
                "92.247.2.26:21231",
                "94.189.133.93:8080",
                "109.92.222.170:53281",
                "79.101.55.161:53281",
                "194.106.175.218:8080",
                "178.79.24.36:8080",
                "2.236.16.113:3128",
                "95.141.36.112:8686",
                "89.204.214.142:8080",
                "54.220.128.74:80",
                "195.13.201.98:30716",
                "91.142.12.1:8081",
                "13.49.144.251:20048",
                "94.68.245.147:8080",
                "193.137.11.212:80",
                "213.181.99.67:80"
            };
            //https://openproxy.space/list/ZTABrk0Fn3
            Random rnd = new Random();
            string host = hosts[rnd.Next(0, hosts.Length - 1)];
            String[] pieces = host.Split(':');

            EventLog.WriteEntry(this.ToString(), String.Format("Selected proxy server '{0}'.", host), EventLogEntryType.Information);
            return new WebProxy(pieces[0], Int32.Parse(pieces[1]));
        }

        private double GetAverage(decimal n1, short n2, short n3)
        {
            return Convert.ToDouble((n1 + n2 + n3) / 3);
        }

        public String Get(String url, Boolean useProxy = true)
        {
            try
            {
                if (url.EndsWith(".pdf") ||
                    url.EndsWith(".tif") ||
                    url.EndsWith(".png") ||
                    url.EndsWith(".doc") ||
                    url.EndsWith(".docx") ||
                    url.EndsWith(".jpg") ||
                    url.EndsWith(".jpeg") ||
                    url.EndsWith(".eps"))
                    throw new FormatException(String.Format("File type is not supported for html parsing '{0}'", url));


                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
                request.AutomaticDecompression = DecompressionMethods.GZip | DecompressionMethods.Deflate;
                request.Timeout = 10000;

                if (useProxy)
                    request.Proxy = this.Proxy;


                using (HttpWebResponse response = (HttpWebResponse)request.GetResponse())
                using (Stream stream = response.GetResponseStream())
                using (StreamReader reader = new StreamReader(stream))
                {
                    return reader.ReadToEnd();
                }
            }
            catch (WebException wex)
            {
                //Force reload proxy if it fails
                EventLog.WriteEntry(this.ToString(), "Forcing proxy to reload due to WebException.", EventLogEntryType.Information);
                this._proxy = null;
                throw wex;
            }
            catch (FormatException fex)
            {
                throw fex;
            }

        }
        private Proxy GetProxyFromSource(string url)
        {
            return JsonConvert.DeserializeObject<Proxy>(this.Get(url, false));
        }
    }
}
